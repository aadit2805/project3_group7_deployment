generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  order_id      Int             @id @default(autoincrement())
  staff_id      Int?
  datetime      DateTime?       @db.Timestamp(6)
  price         Float?
  order_status  String?         @db.VarChar(50)
  customer_name String?         @db.VarChar(255)
  completed_at  DateTime?       @db.Timestamp(6)
  customerId    String? // Link to Customer.id
  customer      Customer?       @relation(fields: [customerId], references: [id])
  staff         staff?          @relation(fields: [staff_id], references: [staff_id], onDelete: NoAction, onUpdate: NoAction)
  meal          meal[]
  payment       payment[]
  discounts     OrderDiscount[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model dailysummaries {
  summary_id    Int       @id @default(autoincrement())
  business_date DateTime  @unique @db.Date
  total_sales   Decimal   @default(0.00) @db.Decimal(10, 2)
  total_tax     Decimal   @default(0.00) @db.Decimal(10, 2)
  net_sales     Decimal   @default(0.00) @db.Decimal(10, 2)
  order_count   Int       @default(0)
  status        String    @db.VarChar(20)
  opened_at     DateTime? @default(now()) @db.Timestamptz(6)
  closed_at     DateTime? @db.Timestamptz(6)
}

model inventory {
  inventory_id Int         @id
  menu_item_id Int?
  stock        Int?
  reorder      Boolean?
  storage      String?     @db.VarChar(255)
  menu_items   menu_items? @relation(fields: [menu_item_id], references: [menu_item_id], onDelete: Cascade, onUpdate: NoAction)
}

model meal {
  meal_id      Int           @id @default(autoincrement())
  order_id     Int?
  meal_type_id Int?
  meal_types   meal_types?   @relation(fields: [meal_type_id], references: [meal_type_id], onDelete: NoAction, onUpdate: NoAction)
  Order        Order?        @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction)
  meal_detail  meal_detail[]
}

model meal_detail {
  detail_id    Int         @id @default(autoincrement())
  meal_id      Int?
  meal_type_id Int?
  menu_item_id Int?
  role         String?     @db.VarChar(50)
  meal         meal?       @relation(fields: [meal_id], references: [meal_id], onDelete: NoAction, onUpdate: NoAction)
  meal_types   meal_types? @relation(fields: [meal_type_id], references: [meal_type_id], onDelete: NoAction, onUpdate: NoAction)
  menu_items   menu_items? @relation(fields: [menu_item_id], references: [menu_item_id], onDelete: NoAction, onUpdate: NoAction)
}

model meal_types {
  meal_type_id    Int           @id
  meal_type_name  String?       @db.VarChar(255)
  meal_type_price Float?
  entree_count    Int?
  side_count      Int?
  drink_size      String?       @db.VarChar(50)
  meal            meal[]
  meal_detail     meal_detail[]
}

model menu_items {
  menu_item_id            Int           @id
  name                    String?       @db.VarChar(255)
  upcharge                Float?
  is_available            Boolean?
  item_type               String?       @db.VarChar(50)
  availability_start_time String?       @db.VarChar(10)
  availability_end_time   String?       @db.VarChar(10)
  inventory               inventory[]
  meal_detail             meal_detail[]
}

model non_food_inventory {
  supply_id Int      @id
  name      String?  @db.VarChar(255)
  stock     Int?
  reorder   Boolean?
}

model payment {
  payment_id Int      @id
  order_id   Int?
  method     String?  @db.VarChar(255)
  amount     Decimal? @db.Decimal(10, 2)
  Order      Order?   @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction)
}

model staff {
  staff_id            Int                   @id @default(autoincrement())
  username            String                @unique @db.VarChar(255)
  password_hash       String                @db.VarChar(255)
  role                String                @default("CASHIER") @db.VarChar(50)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Order               Order[]
  AuditLog            AuditLog[]
  PromotionalDiscount PromotionalDiscount[]
}

model Customer {
  id             String   @id @default(uuid())
  email          String?  @unique
  phone_number   String?  @unique
  password_hash  String
  rewards_points Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  orders         Order[]

  @@index([email])
  @@index([phone_number])
}

model User {
  id        Int      @id @default(autoincrement())
  googleId  String?  @unique
  email     String?  @unique
  name      String?
  role      String?  @default("MANAGER") @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  staff_id    Int? // Staff member who performed the action
  staff       staff?   @relation(fields: [staff_id], references: [staff_id], onDelete: SetNull, onUpdate: NoAction)
  action_type String   @db.VarChar(50) // CREATE, UPDATE, DELETE, DEACTIVATE, etc.
  entity_type String   @db.VarChar(50) // menu_item, staff, inventory, order, user, etc.
  entity_id   String?  @db.VarChar(255) // ID of the affected entity (as string to handle different ID types)
  old_values  String?  @db.Text // JSON string of old values
  new_values  String?  @db.Text // JSON string of new values
  description String?  @db.VarChar(500) // Human-readable description
  ip_address  String?  @db.VarChar(45) // IPv4 or IPv6 address
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@index([staff_id])
  @@index([entity_type, entity_id])
  @@index([created_at])
  @@index([action_type])
}

model PromotionalDiscount {
  id                  Int             @id @default(autoincrement())
  code                String          @unique @db.VarChar(50) // Discount code (e.g., "SUMMER20")
  name                String          @db.VarChar(255) // Display name (e.g., "Summer Sale")
  description         String?         @db.Text // Description of the promotion
  discount_type       String          @db.VarChar(20) // "PERCENTAGE" or "FIXED_AMOUNT"
  discount_value      Decimal         @db.Decimal(10, 2) // Percentage (0-100) or fixed amount in dollars
  min_order_amount    Decimal?        @db.Decimal(10, 2) // Minimum order amount to apply discount
  max_discount_amount Decimal?        @db.Decimal(10, 2) // Maximum discount amount (for percentage discounts)
  start_date          DateTime        @db.Timestamptz(6) // When the promotion starts
  end_date            DateTime        @db.Timestamptz(6) // When the promotion ends
  is_active           Boolean         @default(true) // Whether the discount is currently active
  usage_limit         Int? // Maximum number of times this discount can be used (null = unlimited)
  usage_count         Int             @default(0) // Current usage count
  created_by          Int? // Staff member who created the discount
  created_by_staff    staff?          @relation(fields: [created_by], references: [staff_id], onDelete: SetNull, onUpdate: NoAction)
  created_at          DateTime        @default(now()) @db.Timestamptz(6)
  updated_at          DateTime        @updatedAt @db.Timestamptz(6)
  OrderDiscount       OrderDiscount[]

  @@index([code])
  @@index([is_active])
  @@index([start_date, end_date])
  @@index([created_by])
}

model OrderDiscount {
  id              Int                 @id @default(autoincrement())
  order_id        Int // Order that used this discount
  discount_id     Int // Promotional discount used
  discount        PromotionalDiscount @relation(fields: [discount_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  discount_amount Decimal             @db.Decimal(10, 2) // Actual discount amount applied
  order           Order               @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
  created_at      DateTime            @default(now()) @db.Timestamptz(6)

  @@index([order_id])
  @@index([discount_id])
}
